
version: 2

models:
  - name: listens_flat
    description: Base model which extracts JSON from the source listens table.
    columns:
      - name: listen_md5
        description: The unique md5 of the listen event, generated by the ingestion script.
        tests:
          - not_null
          - unique
      - name: username
        tests:
          - not_null
      - name: listen_at_ts_utc
        tests:
          - not_null
      - name: recording_msid
        tests:
          - not_null
      - name: track_name
      - name: artist_name
      - name: release_name
      - name: release_mbid
      - name: recording_mbid
      - name: artist_mbids
      - name: caa_release_mbid
      - name: duration_ms
      - name: tracknumber
      - name: _lb_insert_ts_utc
        description: |
          Timestamp of the last update for the listen in listenbrainz. May be later than
          the listen timestamp if, e.g., missing mbids are added.
        tests:
          - not_null
      - name: _ingest_insert_ts_utc
        tests:
          - not_null

  - name: local_files_flat
    description: |
      Local library file metadata, generated by the ingest script.
      Expect much of these data to be messy, as the tags are very hand entered.
    columns:
      - name: filepath
        tests:
          - not_null
          - unique
      - name: file_created_at
        description: |
          Least of file ctime, mtime. This is done due to platform differences in what
          those stamps mean.
        tests:
          - not_null
      - name: track_name
      - name: album_name
      - name: artist_name
      - name: album_artist_name
      - name: track_date
      - name: track_year
        description: First 4 caracters of the date. Skipped if not integers.
      - name: track_length_seconds
      - name: recording_mbid
      - name: release_mbid
      - name: artist_mbid
      - name: insert_ts_utc
        tests:
          - not_null

  - name: similar_user_activity_flat
    description: Listen counts for similar users across different entities and time ranges.
    columns:
      - name: similar_user_activity_id
        tests:
          - not_null
          - unique
      - name: mbid
        tests:
          - not_null
      - name: listen_count
        tests:
          - not_null
      - name: from_username
        tests:
          - not_null
      - name: to_username
        tests:
          - not_null
      - name: user_similarity
        tests:
          - not_null
      - name: activity_from_ts
        tests:
          - not_null
      - name: activity_to_ts
        tests:
          - not_null
      - name: entity
        tests:
          - not_null
      - name: ingest_payload_id
        description: Hash of (from, to, entity, time range).
        tests:
          - not_null
      - name: insert_ts_utc
        tests:
          - not_null

  - name: mbids
    description: Long format list of every mbid in the system and the entity to which it applies.
    columns:
      - name: mbid
        tests:
          - not_null
          - unique
      - name: entity
        tests:
          - not_null

