
version: 2

models:
  - name: listens_flat
    description: Base model which extracts JSON from the source listens table.
    tests:
      - dbt_utils.expression_is_true:
          expression: "_lb_insert_ts_utc > listen_at_ts_utc"
      - dbt_utils.expression_is_true:
          expression: "_ingest_insert_ts_utc > _lb_insert_ts_utc"
    columns:
      - name: listen_md5
        description: The unique md5 of the listen event, generated by the ingestion script.
        tests:
          - not_null
          - unique
      - name: username
        tests:
          - not_null
      - name: listen_at_ts_utc
        tests:
          - not_null
      - name: recording_msid
        tests:
          - not_null
      - name: track_name
      - name: artist_name
      - name: release_name
      - name: release_mbid
      - name: recording_mbid
      - name: caa_release_mbid
      - name: duration_ms
      - name: tracknumber
      - name: _lb_insert_ts_utc
        tests:
          - not_null
      - name: _ingest_insert_ts_utc
        tests:
          - not_null

  - name: local_files_flat
    description: |
      Local library file metadata, generated by the ingest script.
      Expect much of these data to be messy, as the tags are very hand entered.
    tests:
      - dbt_utils.expression_is_true:
          expression: "insert_ts_utc > file_created_at"
    columns:
      - name: filepath
        tests:
          - not_null
          - unique
      - name: file_created_at
        description: |
          Least of file ctime, mtime. This is done due to platform differences in what
          those stamps mean.
        tests:
          - not_null
      - name: track_name
      - name: album_name
      - name: artist_name
      - name: album_artist_name
      - name: track_date
      - name: track_year
        description: First 4 caracters of the date. Skipped if not integers.
      - name: track_length_seconds
      - name: track_mbid
      - name: artist_mbid
      - name: insert_ts_utc
        tests:
          - not_null

    